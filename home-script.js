// Funci√≥n para verificar si el usuario est√° autenticado
function checkAuthentication() {
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    const loginTime = localStorage.getItem('loginTime');
    
    // Verificar si no est√° logueado
    if (isLoggedIn !== 'true') {
        redirectToLogin();
        return false;
    }
    
    // Verificar si la sesi√≥n ha expirado (opcional: 24 horas)
    if (loginTime) {
        const loginDate = new Date(loginTime);
        const now = new Date();
        const hoursDifference = (now - loginDate) / (1000 * 60 * 60);
        
        // Si han pasado m√°s de 24 horas, cerrar sesi√≥n
        if (hoursDifference > 24) {
            logout();
            return false;
        }
    }
    
    return true;
}

// Funci√≥n para redirigir al login
function redirectToLogin() {
    console.log('‚ùå Usuario no autenticado, redirigiendo al login...');
    window.location.href = './index.html';
}

// Funci√≥n para cerrar sesi√≥n
function logout() {
    console.log('‚è∞ Sesi√≥n expirada, cerrando sesi√≥n...');
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('loginTime');
    redirectToLogin();
}

// Verificar autenticaci√≥n al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    checkAuthentication();
    
    // Event listener para el formulario de calendario
    const calendarForm = document.getElementById('calendarForm');
    if (calendarForm) {
        calendarForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.querySelector('.submit-btn');
            const originalText = submitBtn.textContent;
            
            // Mostrar estado de carga
            submitBtn.textContent = 'üì§ Enviando...';
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.7';
            
            const formData = {
                eventDate: document.getElementById('eventDate').value,
                eventTitle: document.getElementById('eventTitle').value,
                dayActivity: document.querySelector('input[name="dayActivity"]:checked')?.value || '',
                italianFood: document.querySelector('input[name="italianFood"]:checked')?.value || '',
                liveMusic: document.querySelector('input[name="liveMusic"]:checked')?.value || '',
                nightView: document.querySelector('input[name="nightView"]:checked')?.value || '',
                dancing: document.querySelector('input[name="dancing"]:checked')?.value || '',
                specialRequest: document.getElementById('specialRequest').value
            };
            
            try {
                const result = await sendCalendarData(formData);
                
                if (result.success) {
                    // Mostrar √©xito
                    submitBtn.textContent = '‚úÖ ¬°Enviado!';
                    submitBtn.style.background = 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)';
                    
                    setTimeout(() => {
                        closeModal('modalCalendar');
                        calendarForm.reset();
                        
                        // Restaurar bot√≥n
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '1';
                        submitBtn.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                    }, 2000);
                } else {
                    // Mostrar error
                    submitBtn.textContent = '‚ùå Error - Reintentar';
                    submitBtn.style.background = 'linear-gradient(135deg, #e67e22 0%, #d35400 100%)';
                    
                    setTimeout(() => {
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '1';
                        submitBtn.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                    }, 3000);
                }
            } catch (error) {
                // Mostrar error de conexi√≥n
                submitBtn.textContent = '‚ùå Sin conexi√≥n';
                submitBtn.style.background = 'linear-gradient(135deg, #e67e22 0%, #d35400 100%)';
                
                setTimeout(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                }, 3000);
            }
        });
    }
});

// Funci√≥n para enviar datos del calendario por email usando W3Forms
async function sendCalendarData(formData) {
    try {
        const now = new Date();
        const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const formattedDate = now.toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });

        const eventDate = new Date(formData.eventDate);
        const formattedEventDate = eventDate.toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });

        const w3FormData = new FormData();
        w3FormData.append('access_key', '73afd12b-ac6e-4283-be57-9527b2e18984');
        w3FormData.append('name', 'Sistema de Calendario - Cartas del Coraz√≥n');
        w3FormData.append('email', 'calendario-notification@cartas-corazon.com');
        w3FormData.append('subject', `Nueva planificaci√≥n: ${formData.eventTitle}`);
        w3FormData.append('message', `¬°Hola! 

Tu pareja ha planificado algo especial contigo:

üìÖ DETALLES DEL EVENTO:
‚Ä¢ Actividad: ${formData.eventTitle}
‚Ä¢ Fecha y hora: ${formattedEventDate}

üí≠ SUS PREFERENCIAS:
‚Ä¢ Te recojo en casa: ${formData.dayActivity}
‚Ä¢ Vestirnos del mismo color: ${formData.italianFood}
‚Ä¢ Vista nocturna: ${formData.nightView}
‚Ä¢ Bailar: ${formData.dancing}

${formData.specialRequest ? `‚ú® PETICI√ìN ESPECIAL:\n${formData.specialRequest}\n\n` : ''}üìß INFORMACI√ìN DEL ENV√çO:
‚Ä¢ Enviado el: ${formattedDate}
‚Ä¢ Zona horaria: ${timeZone}

¬°Espero que puedan disfrutar juntos de este momento especial! üíñ

Con amor,
Tu sistema de planificaci√≥n rom√°ntica üíï`);

        const response = await fetch('https://api.web3forms.com/submit', {
            method: 'POST',
            body: w3FormData
        });

        if (response.ok) {
            console.log('‚úÖ Datos del calendario enviados exitosamente');
            return { success: true, message: '¬°Planificaci√≥n enviada exitosamente! üíï' };
        } else {
            console.log('‚ö†Ô∏è Error al enviar datos del calendario');
            return { success: false, message: 'Error al enviar la planificaci√≥n. Int√©ntalo de nuevo.' };
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Error al enviar datos del calendario:', error);
        return { success: false, message: 'Error de conexi√≥n. Verifica tu internet e int√©ntalo de nuevo.' };
    }
}

// Funci√≥n para enviar notificaci√≥n por email cuando se abre un modal
async function sendModalNotification(modalTitle) {
    try {
        // Obtener la hora local del sistema
        const now = new Date();
        const openTime = now.toLocaleString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        
        // Tambi√©n incluir la zona horaria detectada autom√°ticamente
        const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        
        const formData = new FormData();
        formData.append('access_key', '73afd12b-ac6e-4283-be57-9527b2e18984');
        formData.append('name', 'Sistema de Modales - Cartas del Coraz√≥n');
        formData.append('email', 'modal-notification@cartas-corazon.com');
        formData.append('subject', 'Modal abierto: ' + modalTitle);
        formData.append('message', `
¬°Hola! üíå

Te informo que se acaba de abrir una carta del coraz√≥n en la p√°gina.

üìã Detalles:
‚Ä¢ Carta abierta: "${modalTitle}"
‚Ä¢ Fecha y hora: ${openTime}
‚Ä¢ Zona horaria: ${timeZone}
‚Ä¢ P√°gina: Cartas del Coraz√≥n
‚Ä¢ Estado: Modal abierto ‚úÖ

üíï ¬°Alguien est√° leyendo tus cartas de amor!

---
Notificaci√≥n autom√°tica del sistema de modales
        `);
        
        const response = await fetch('https://api.web3forms.com/submit', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            console.log('‚úÖ Notificaci√≥n de modal enviada exitosamente para:', modalTitle);
        } else {
            console.log('‚ö†Ô∏è Error al enviar notificaci√≥n de modal');
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Error al enviar notificaci√≥n:', error);
    }
}

function openModal(modalId) {
    // Verificar autenticaci√≥n antes de abrir el modal
    if (!checkAuthentication()) {
        return; // Si no est√° autenticado, no abrir el modal
    }
    
    const modal = document.getElementById(modalId);
    const modalTitle = modal.querySelector('.modal-title').textContent;
    
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevenir scroll del body
    
    // Enviar notificaci√≥n por email
    sendModalNotification(modalTitle);
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.body.style.overflow = 'auto'; // Restaurar scroll del body
}

// Cerrar modal al hacer click fuera del contenido
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });
}

// Cerrar modal con la tecla Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
    }
});

// Soporte para navegaci√≥n por teclado
document.querySelectorAll('.card').forEach(card => {
    card.setAttribute('tabindex', '0');
    card.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.click();
        }
    });
});